---
description: Swift and iOS development rules for 7verse app
globs: 
  - "**/*.swift"
  - "**/*.storyboard"
  - "**/*.xib"
alwaysApply: true
---

You are an expert Swift and iOS developer working on the 7verse iOS app.

## Execution Philosophy
- Execute directly without asking for confirmation unless there's significant risk (data loss, destructive git operations)
- When asked to "fix" or "implement", analyze and execute in one turn
- Make reasonable assumptions and proceed
- Minimize back-and-forth

## Swift Development - Dev Build Mode
The user is in development mode and wants ALL issues exposed immediately. No silent fallbacks.

### Core Principles
1. **Fail Fast**: Prefer crashes over silent failures. Use `fatalError()`, `precondition()`, and `assert()` liberally
2. **Force Unwrap When Appropriate**: Use `!` instead of `??` when you expect data to exist. Let it crash with a clear stack trace
3. **No Error Swallowing**: Never use `try?` or empty `catch {}` blocks. Always propagate or crash with details
4. **Verbose Logging**: Add `print()` statements with clear prefixes to trace data flow, API calls, state changes
5. **Type Safety**: Avoid `Any`, `AnyObject`. Make types explicit and narrow
6. **No Default Values for Critical Data**: Don't use `?? []` or `?? ""` for data that should always exist

### Example Patterns

```swift
// ‚ùå Production style (hides issues)
let posts = try? await fetchPosts() ?? []

// ‚úÖ Dev style (exposes issues)
do {
    let posts = try await fetchPosts()
    print("‚úÖ Fetched \(posts.count) posts")
} catch {
    print("‚ùå FATAL: \(error)")
    fatalError("Cannot load posts: \(error)")
}
```

```swift
// ‚ùå Silent fallback
let hashtags = (try? container.decode([String].self, forKey: .hashtags)) ?? []

// ‚úÖ Fail fast with context
let hashtags = try container.decode([String].self, forKey: .hashtags)
// If this crashes, we know exactly what's wrong
```

### Conditional Compilation for Future
When ready for production, wrap dev-mode crashes:
```swift
#if DEBUG
fatalError("Dev: Data malformed")
#else
// Graceful fallback for production
return []
#endif
```

## Code Style
- Swift conventions: camelCase for properties/methods, PascalCase for types
- Prefer `let` over `var`
- Use explicit `self` only when required
- Keep functions small and focused
- Use `// MARK: -` to organize code sections

## SwiftUI Practices
- Prefer SwiftUI over UIKit
- Set `.preferredColorScheme()` explicitly during dev
- Test on both iPhone and iPad simulators

## Error Messages
- Prefix all print statements with module/context: `[FeedViewModel]`, `[APIService]`, etc.
- Use emoji for quick scanning: ‚úÖ success, ‚ùå error, ‚ö†Ô∏è warning, üîç debug, üîÑ loading

## Git Rules
- NEVER force push to main/master
- NEVER skip git hooks unless explicitly requested
- Write clear, descriptive commit messages

## File Organization
- Models in `Models/`, Views in `Views/`, Services in `Services/`
- Delete unused files immediately
- No commented-out code or orphaned TODOs

## File Restrictions
- **NEVER edit .sql files** - SQL files are managed by the database team
- **Read-only for .sql**: You can read .sql files to understand schema, but never modify them
- If SQL changes are needed, inform the user and provide the SQL as suggestions only

## Supabase Integration Best Practices

### Critical Debugging Checklist

When facing "0 results" from Supabase despite having data:

1. **RLS (Row Level Security) Issues**
   - Check if RLS is enabled: `SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'your_table';`
   - If enabled, verify policies exist for your role: `SELECT * FROM pg_policies WHERE tablename = 'your_table';`
   - **Quick fix for dev**: `ALTER TABLE public."your_table" DISABLE ROW LEVEL SECURITY;`
   - Service role key should bypass RLS, but policies may still block

2. **API Key Validation**
   ```swift
   // Decode JWT to verify role
   let jwtParts = key.split(separator: ".")
   if let payload = Data(base64Encoded: String(jwtParts[1])) {
       print(String(data: payload, encoding: .utf8))  // Check "role": "service_role" or "anon"
   }
   ```

3. **Query Simplification**
   - Start with simplest query: `.from("table").select().execute().value`
   - No `.order()`, `.eq()`, `.limit()`, or other filters
   - Add conditions incrementally after confirming data fetches

4. **Error Handling (NEVER use `try?`)**
   ```swift
   // ‚ùå BAD: Swallows errors silently
   let posts = try? await client.from("posts").select().execute().value ?? []
   
   // ‚úÖ GOOD: Exposes all errors
   do {
       let posts: [Post] = try await client
           .from("posts")
           .select()
           .execute()
           .value
       print("‚úÖ Fetched \(posts.count) posts")
   } catch {
       print("‚ùå Supabase error: \(error)")
       throw error  // Don't swallow
   }
   ```

5. **Model Mapping**
   - Ensure Swift model fields match Supabase schema EXACTLY
   - Use `CodingKeys` for snake_case to camelCase conversion
   - Check for optional vs required fields mismatch
   - Add detailed logging in custom `init(from decoder:)` during dev

6. **Table Names with Numbers**
   - Tables starting with numbers (e.g., `7verse_posts`) need special handling
   - Supabase SDK handles this automatically - don't manually quote: `from("7verse_posts")` ‚úÖ
   - NOT `from("\"7verse_posts\"")` ‚ùå

7. **xcconfig URL Parsing**
   - URLs with `://` may be truncated in xcconfig files
   - Fallback to hardcoded values in Secrets.swift for reliability
   - Validate URL before using: check length, presence of protocol, domain

### Supabase SDK Patterns

```swift
// Correct usage (latest SDK)
let items: [Item] = try await client
    .from("items")
    .select()
    .order("created_at", ascending: false)
    .execute()
    .value  // Directly get decoded value

// NOT .execute().underlyingResponse (older SDK)
```

### Common Pitfalls

- ‚ùå Using `try?` - hides decoding errors
- ‚ùå Forgetting `await` - compilation error or silent failure
- ‚ùå Wrong table name or schema
- ‚ùå Model fields don't match database columns
- ‚ùå RLS enabled but no policies for service_role
- ‚ùå Using `anon` key when `service_role` key is needed
